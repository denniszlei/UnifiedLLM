version: '3.8'

services:
  # UnifiedLLM - Configuration orchestrator
  unifiedllm:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: unifiedllm
    ports:
      - "${UNIFIEDLLM_PORT:-8000}:8000"
    environment:
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - GPTLOAD_URL=http://gptload:3001
      - GPTLOAD_AUTH_KEY=${GPTLOAD_AUTH_KEY}
      - DATABASE_URL=sqlite:///./data/unifiedllm.db
      - APP_HOST=0.0.0.0
      - APP_PORT=8000
    volumes:
      # Persist database
      - unifiedllm-data:/app/data
      # Share uni-api config
      - uni-api-config:/app/uni-api-config
    depends_on:
      gptload:
        condition: service_healthy
    networks:
      - llm-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/api/health', timeout=5.0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # GPT-Load - Load balancing API gateway
  gptload:
    image: ${GPTLOAD_IMAGE:-ghcr.io/gptload/gptload:latest}
    container_name: gptload
    ports:
      - "${GPTLOAD_PORT:-3001}:3001"
    environment:
      - AUTH_KEY=${GPTLOAD_AUTH_KEY}
      - PORT=3001
      - DATABASE_URL=sqlite:///./data/gptload.db
    volumes:
      # Persist GPT-Load database and configuration
      - gptload-data:/app/data
    networks:
      - llm-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/api/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # uni-api - Unified API gateway
  uni-api:
    image: ${UNI_API_IMAGE:-yym68686/uni-api:latest}
    container_name: uni-api
    ports:
      - "${UNI_API_PORT:-8001}:8000"
    environment:
      - PORT=8000
    volumes:
      # Mount generated api.yaml configuration
      - uni-api-config:/app/api.yaml:ro
    depends_on:
      gptload:
        condition: service_healthy
    networks:
      - llm-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  # Persistent storage for UnifiedLLM database
  unifiedllm-data:
    driver: local
  
  # Persistent storage for GPT-Load database and configuration
  gptload-data:
    driver: local
  
  # Shared volume for uni-api configuration file
  uni-api-config:
    driver: local

networks:
  # Internal network for service communication
  llm-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
